<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Paneli | IMS Library</title>
    <link rel="stylesheet" href="genel.css" />
</head>
<body>

<header class="navbar">
    <div class="logo">
        <img src="logo.png" alt="IMS Library Logo" />
        <h1>IMS Library</h1>
    </div>
    <nav>
        <ul class="nav-links">
            <li><a href="index.html">Ana Sayfa</a></li>
            <li><a href="hakkimizda.html">Hakkımızda</a></li>
            <li><a href="misyon-vizyon.html">Misyon & Vizyon</a></li>
            <li><a href="iletisim.html">İletişim</a></li>
        </ul>
    </nav>
</header>

<!-- DASHBOARD -->
<main class="admin-container">
    <aside class="admin-sidebar">
        <div class="admin-profile">
            <img src="logo.png" alt="admin" />
            <div>
                <h3>Admin</h3>
                <p>IMS.admin@univ.edu</p>
            </div>
        </div>

        <ul class="admin-menu">
            <li class="active">Panoya Genel Bakış</li>
            <li>Kitap Yönetimi</li>
            <li>Kullanıcılar</li>
            <li>Duyurular</li>
            <li>Ayarlar</li>
        </ul>

        <div class="small-note">
            <strong>Not:</strong>
            Bu panel demo amaçlıdır. Gerçek projede sunucu tarafı doğrulama gereklidir.
        </div>
    </aside>

    <section class="admin-main">
        <div class="dashboard-header">
            <h2>Yönetici Paneli</h2>
            <div class="header-actions">
                <button id="exportBtn" class="btn small">CSV Dışa Aktar</button>
                <button id="clearStorage" class="btn small ghost">Local Verileri Temizle</button>
            </div>
        </div>

        <!-- KARTLAR -->
        <div class="cards">
            <div class="card">
                <h4>Toplam Kitap</h4>
                <p id="totalBooks">0</p>
            </div>
            <div class="card">
                <h4>Toplam Kullanıcı</h4>
                <p id="totalUsers">0</p>
            </div>
            <div class="card">
                <h4>Aktif Duyurular</h4>
                <p id="totalAnnouncements">0</p>
            </div>
        </div>

        <!-- Kitap Yönetimi -->
        <div class="panel">
            <div class="panel-header">
                <h3>Kitap Yönetimi</h3>
                <p class="muted">Yeni kitap ekleyin, düzenleyin veya silin.</p>
            </div>

            <div class="panel-body two-col">
                <form id="bookForm" class="panel-form">
                    <h4>Yeni Kitap Ekle</h4>
                    <label>Başlık
                        <input type="text" id="bookTitle" placeholder="Kitap başlığı" required />
                    </label>
                    <label>Yazar
                        <input type="text" id="bookAuthor" placeholder="Yazar adı" required />
                    </label>
                    <label>Yayın Yılı
                        <input type="number" id="bookYear" placeholder="2024" min="1000" max="2100" />
                    </label>
                    <label>Kategori
                        <input type="text" id="bookCategory" placeholder="Kategori (örn. Bilgisayar)" />
                    </label>
                    <div class="form-row">
                        <button type="submit" class="btn">Ekle</button>
                        <button type="button" id="importSample" class="btn ghost">Örnek Ekle</button>
                    </div>
                </form>

                <div class="table-wrap">
                    <h4>Kitap Listesi</h4>
                    <input id="bookSearch" placeholder="Kitap ara..." />
                    <table id="booksTable" class="table">
                        <thead>
                        <tr><th>Başlık</th><th>Yazar</th><th>Yıl</th><th>Kategori</th><th>İşlemler</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Kullanıcı Yönetimi -->
        <div class="panel">
            <div class="panel-header">
                <h3>Kullanıcılar</h3>
                <p class="muted">Kayıtlı kullanıcıları görüntüleyin ve yönetim notları ekleyin.</p>
            </div>

            <div class="panel-body">
                <div class="users-controls">
                    <input id="userSearch" placeholder="Kullanıcı ara (isim veya eposta)" />
                    <button id="addSampleUsers" class="btn ghost">Örnek Kullanıcı Ekle</button>
                </div>

                <table id="usersTable" class="table">
                    <thead>
                    <tr><th>Ad</th><th>E-Posta</th><th>Rol</th><th>İşlemler</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Duyurular -->
        <div class="panel">
            <div class="panel-header">
                <h3>Duyurular</h3>
                <p class="muted">Yeni duyuru ekleyin, düzenleyin veya yayınlayın.</p>
            </div>

            <div class="panel-body two-col">
                <form id="announceForm" class="panel-form">
                    <h4>Yeni Duyuru</h4>
                    <label>Başlık
                        <input type="text" id="annTitle" placeholder="Duyuru başlığı" required />
                    </label>
                    <label>İçerik
                        <textarea id="annContent" rows="5" placeholder="Duyuru metni..." required></textarea>
                    </label>
                    <div class="form-row">
                        <button type="submit" class="btn">Yayınla</button>
                    </div>
                </form>

                <div class="ann-list">
                    <h4>Mevcut Duyurular</h4>
                    <ul id="announcements"></ul>
                </div>
            </div>
        </div>

    </section>
</main>

<footer>
    <p>© 2025 IMS Library | İstanbul Medeniyet Üniversitesi</p>
</footer>

<script>
    /* Yardımcılar */
    const $ = (s) => document.querySelector(s);

    /* Global Veri Dizileri */
    let books = [];
    let users = [];

    /* DOM Referansları */
    const booksTbody = $('#booksTable tbody');
    const usersTbody = $('#usersTable tbody');
    const totalBooksEl = $('#totalBooks');
    const totalUsersEl = $('#totalUsers');

    /* --- VERİ ÇEKME FONKSİYONLARI --- */
    async function fetchBooks() {
        try {
            const response = await fetch('get_books.php');
            const data = await response.json();
            books = data; // Gelen veriyi global `books` dizisine ata
            renderBooks(); // Tabloyu yeniden çiz
        } catch (error) {
            console.error('Kitapları çekerken hata oluştu:', error);
            booksTbody.innerHTML = `<tr><td colspan="5" style="color: red;">Hata: Kitaplar yüklenemedi.</td></tr>`;
        }
    }

    async function fetchUsers() {
        try {
            const response = await fetch('get_users.php');
            const data = await response.json();
            users = data;
            renderUsers();
        } catch (error) {
            console.error('Kullanıcıları çekerken hata oluştu:', error);
            usersTbody.innerHTML = `<tr><td colspan="4" style="color: red;">Hata: Kullanıcılar yüklenemedi.</td></tr>`;
        }
    }

    /* --- ARAYÜZ GÜNCELLEME (RENDER) FONKSİYONLARI --- */
    function renderBooks(filter = '') {
        const filtered = books.filter(b =>
            (b.name + ' ' + b.author).toLowerCase().includes(filter.toLowerCase())
        );
        booksTbody.innerHTML = ''; // Tabloyu temizle
        if (filtered.length === 0) {
            booksTbody.innerHTML = '<tr><td colspan="5">Kitap bulunamadı.</td></tr>';
        } else {
            filtered.forEach(b => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(b.name)}</td>
                    <td>${escapeHtml(b.author)}</td>
                    <td>${escapeHtml(b.year || '—')}</td>
                    <td>Genel</td> <td class="ops">
                        <button data-id="${b.id}" class="btn ghost small edit-book">Düzenle</button>
                        <button data-id="${b.id}" class="btn danger small del-book">Sil</button>
                    </td>`;
                booksTbody.appendChild(tr);
            });
        }
        totalBooksEl.textContent = books.length;
    }

    function renderUsers(filter = '') {
        const filtered = users.filter(u =>
            (u.username).toLowerCase().includes(filter.toLowerCase())
        );
        usersTbody.innerHTML = '';
        if (filtered.length === 0) {
            usersTbody.innerHTML = '<tr><td colspan="4">Kullanıcı bulunamadı.</td></tr>';
        } else {
            filtered.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(u.username)}</td>
                    <td>-</td> <td>${escapeHtml(u.role)}</td>
                    <td class="ops">
                        <button data-id="${u.id}" class="btn danger small del-user">Sil</button>
                    </td>`;
                usersTbody.appendChild(tr);
            });
        }
        totalUsersEl.textContent = users.length;
    }

    function escapeHtml(s) {
        if (!s) return '';
        return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
    }

    /* --- OLAY DİNLEYİCİLERİ (EVENT LISTENERS) --- */

    // Yeni Kitap Ekleme Formu
    $('#bookForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const bookData = {
            name: $('#bookTitle').value.trim(),
            author: $('#bookAuthor').value.trim(),
            year: $('#bookYear').value
        };

        const response = await fetch('add_book.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bookData)
        });
        const result = await response.json();

        if(result.success) {
            await fetchBooks(); // Kitap listesini yenile
            e.target.reset(); // Formu temizle
        } else {
            alert('Hata: ' + result.message);
        }
    });

    // Kitap Silme ve Düzenleme (Tüm tablo için tek bir listener)
    booksTbody.addEventListener('click', async (ev) => {
        const target = ev.target;
        const bookId = target.dataset.id;

        // SİLME İŞLEMİ
        if (target.matches('.del-book')) {
            if (!confirm('Bu kitabı silmek istediğinize emin misiniz?')) return;

            const response = await fetch('delete_book.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: bookId })
            });
            const result = await response.json();
            if(result.success) await fetchBooks();
            else alert('Hata: ' + result.message);
        }

        // DÜZENLEME İŞLEMİ
        if (target.matches('.edit-book')) {
            const bookToEdit = books.find(b => b.id == bookId);
            if (!bookToEdit) return;

            const newName = prompt('Yeni kitap adı:', bookToEdit.name);
            if (newName === null) return; // Kullanıcı iptale bastı
            const newAuthor = prompt('Yeni yazar adı:', bookToEdit.author);
            if (newAuthor === null) return;
            const newYear = prompt('Yeni yayın yılı:', bookToEdit.year);
            if (newYear === null) return;

            const updatedData = {
                id: bookId,
                name: newName.trim(),
                author: newAuthor.trim(),
                year: newYear
            };

            const response = await fetch('edit_book.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });
            const result = await response.json();
            if(result.success) await fetchBooks();
            else alert('Hata: ' + result.message);
        }
    });

    // Kullanıcı Silme
    usersTbody.addEventListener('click', async (ev) => {
        const target = ev.target;
        if (target.matches('.del-user')) {
            const userId = target.dataset.id;
            if (!confirm('Bu kullanıcıyı kalıcı olarak silmek istediğinize emin misiniz?')) return;

            const response = await fetch('delete_user.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: userId })
            });
            const result = await response.json();
            if(result.success) await fetchUsers(); // Başarılıysa kullanıcı listesini yenile
            else alert('Hata: ' + result.message);
        }
    });

    // Arama Inputları
    $('#bookSearch').addEventListener('input', (e) => renderBooks(e.target.value));
    $('#userSearch').addEventListener('input', (e) => renderUsers(e.target.value));


    /* --- BAŞLANGIÇ FONKSİYONU --- */
    function init() {
        fetchBooks();
        fetchUsers();
        // Diğer localStorage'a bağlı kodlar kaldırıldı.
    }

    init(); // Sayfa yüklendiğinde başlat
</script>
</body>
</html>